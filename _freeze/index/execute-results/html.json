{
  "hash": "1687ac51be7cebebe210d8b54af935b0",
  "result": {
    "engine": "jupyter",
    "markdown": "---\ntitle: \"{{< var pub.title >}} --\"\ndate: 'January 1, 2025'\nabstract-title: \"Summary\"\n---\n\n## Abstract\n\nDespite the header being `## Abstract`, this section will render as a highlighted section titled *Summary*. Ensure this section is a **maximum** of 280 characters.\n\n----\n\n:::{.callout-note title=\"AI usage disclosure\" collapse=\"true\"}\nThis is a placeholder for the AI usage disclosure. Once all authors sign the AI code form on Airtable, SlackBot will message you an AI disclosure that you should place here.\n:::\n\n## Purpose\n\nOnce edited by you, this file will become your publication. Alternatively, if you already have a notebook written that you're trying to transform into a pub, replace this file with your own, but be sure to add the YAML front matter (the first cell) to your notebook.\n\nYour pub should begin with a section titled **Purpose** where you, as briefly as possible, explain why you did the work described in the pub, the key takeaway, your primary audience, and how you think it could be useful to them/why you're sharing it.\n\n## Introduction\n\nThe MSA Pairformer (2025.08.02.668173v1) introduces a 111M-parameter architecture that leverages multiple sequence alignments and a query-biased pair representation to achieve state-of-the-art performance in contact prediction, protein–protein interface identification, and variant effect prediction. Beyond benchmarks, the paper advances a mechanistic claim: that the model mitigates phylogenetic averaging by weighting sequences according to their evolutionary relevance to the query, thereby recovering subfamily-specific signals.\n\nThis interpretation hinges on an assumption that has not been directly tested: that learned sequence weights align with phylogenetic similarity, not merely raw sequence identity. The authors provide indirect evidence—bimodal weight distributions within the response regulator family, improved recovery of subfamily-specific contacts, and weight–identity correlations—but these do not establish whether the model is actually sensitive to tree-based lineage structure.\n\nIn this notebook, we examine the relationship between learned sequence weights and phylogenetic distance. Our goal is not to challenge the reported performance, but to evaluate the evolutionary interpretation. By linking weights to tree-based measures of relatedness, we can clarify whether the Pairformer is genuinely capturing subfamily-specific phylogenetic signal, or whether its behavior is better explained by local sequence identity and compositional effects.\n\n## Re-examining the Response Regulator Case Study\n\nThe original paper highlights the response regulator (RR) family as a case study for subfamily-specific signal. There, query-biased weights displayed a bimodal distribution: sequences belonging to the same subfamily as the query were consistently upweighted, while sequences from other subfamilies were downweighted. This was presented as evidence that the model captures lineage structure, rather than relying solely on raw sequence identity.\n\nTo evaluate this claim more directly, we begin by reproducing the RR multiple sequence alignment (MSA) used in the paper. This alignment serves as the foundation for both the subfamily analysis and our subsequent phylogenetic analysis. By rebuilding the MSA in a transparent, reproducible way, we can:\n\nConfirm that the alignment and sequence set are comparable to those used in the published case study.\n\nProvide input to the MSA Pairformer, enabling us to extract query-biased weights via a forward pass.\n\nEstablish a consistent dataset on which to perform downstream analyses, including the correlation of weights with tree-based phylogenetic distances.\n\nIn the next cell, we will generate the RR MSA. This involves identifying the same protein family and constructing the alignment under similar constraints (e.g., filtering thresholds, depth caps). The resulting MSA will then be used as input to the model, forming the basis of our re-analysis.\n\n::: {#d5b4a911 .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:31.815112Z\",\"iopub.status.busy\":\"2025-10-06T19:53:31.814650Z\",\"iopub.status.idle\":\"2025-10-06T19:53:31.848506Z\",\"shell.execute_reply\":\"2025-10-06T19:53:31.847952Z\"}' execution_count=1}\n``` {.python .cell-code}\n%env USE_MODAL=1\n%load_ext autoreload\n%autoreload 2\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nenv: USE_MODAL=1\n```\n:::\n:::\n\n\n::: {#d9109183 .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:31.850808Z\",\"iopub.status.busy\":\"2025-10-06T19:53:31.850627Z\",\"iopub.status.idle\":\"2025-10-06T19:53:34.160754Z\",\"shell.execute_reply\":\"2025-10-06T19:53:34.160353Z\"}' execution_count=2}\n``` {.python .cell-code}\nfrom pathlib import Path\n\nfrom analysis.pfam import download_and_process_response_regulator_msa\nfrom analysis.tree import read_newick, run_fasttree\n\nfrom MSA_Pairformer.dataset import MSA\n\nresponse_regulator_dir = Path(\"./data/response_regulators\")\nresponse_regulator_dir.mkdir(parents=True, exist_ok=True)\n\nmsas: dict[str, MSA] = {}\n\nqueries = {\"1NXS\": \"OmpR\", \"4CBV\": \"LytTR\", \"4E7P\": \"GerE\"}\nfor query in queries:\n    msa_path = response_regulator_dir / f\"PF00072.final_{query}.a3m\"\n\n    if not msa_path.exists():\n        download_and_process_response_regulator_msa(\n            output_dir=response_regulator_dir,\n            subset_size=4096,\n        )\n\n    msas[query] = MSA(msa_file_path=msa_path, diverse_select_method=\"none\")\n```\n:::\n\n\n::: {#70cbe68b .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:34.162584Z\",\"iopub.status.busy\":\"2025-10-06T19:53:34.162393Z\",\"iopub.status.idle\":\"2025-10-06T19:53:35.895712Z\",\"shell.execute_reply\":\"2025-10-06T19:53:35.895344Z\"}' execution_count=3}\n``` {.python .cell-code}\nimport pandas as pd\nfrom analysis.plotting import tree_style_with_categorical_annotation\nfrom analysis.tree import subset_tree\n\nfasttree_path = response_regulator_dir / \"PF00072.final.fasttree.newick\"\nmsa_for_tree = response_regulator_dir / \"PF00072.final.fasta\"\nif not fasttree_path.exists():\n    run_fasttree(msa_path.with_suffix(\".fasta\"), fasttree_path)\n\ntree = read_newick(fasttree_path)\n\nmembership_path = response_regulator_dir / \"membership.txt\"\ntarget_to_subfamily = (\n    pd.read_csv(membership_path, sep=\"\\t\").set_index(\"record_id\")[\"subfamily\"].to_dict()\n)\n\ntree_style = tree_style_with_categorical_annotation(\n    categories=target_to_subfamily, highlight=list(queries)\n)\nvisualized_tree = subset_tree(tree=tree, n=100, force_include=list(queries), seed=42)\nvisualized_tree.render(\"%%inline\", tree_style=tree_style, dpi=300)\n```\n\n::: {.cell-output .cell-output-display execution_count=3}\n![](index_files/figure-html/cell-4-output-1.png){}\n:::\n:::\n\n\n::: {#a91c577a .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:35.897200Z\",\"iopub.status.busy\":\"2025-10-06T19:53:35.897097Z\",\"iopub.status.idle\":\"2025-10-06T19:53:36.398419Z\",\"shell.execute_reply\":\"2025-10-06T19:53:36.398052Z\"}' execution_count=4}\n``` {.python .cell-code}\nfrom typing import Any\n\nimport torch\nfrom analysis.pairformer import run_inference\n\ninference_results_path = response_regulator_dir / \"inference_results.pt\"\nif inference_results_path.exists():\n    inference_results = torch.load(inference_results_path)\nelse:\n    inference_results: dict[str, dict[str, Any]] = {}\n    for query in queries:\n        inference_results[query] = run_inference(\n            msas[query], return_seq_weights=True, query_only=True\n        )\n\n    torch.save(inference_results, inference_results_path)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n/var/folders/v4/q0wyvpsj4h901lfkjcln68nw0000gn/T/ipykernel_29518/3529439177.py:8: FutureWarning:\n\nYou are using `torch.load` with `weights_only=False` (the current default value), which uses the default pickle module implicitly. It is possible to construct malicious pickle data which will execute arbitrary code during unpickling (See https://github.com/pytorch/pytorch/blob/main/SECURITY.md#untrusted-models for more details). In a future release, the default value for `weights_only` will be flipped to `True`. This limits the functions that could be executed during unpickling. Arbitrary objects will no longer be allowed to be loaded via this mode unless they are explicitly allowlisted by the user via `torch.serialization.add_safe_globals`. We recommend you start setting `weights_only=True` for any use case where you don't have full control of the loaded file. Please open an issue on GitHub for any issues related to this experimental feature.\n\n```\n:::\n:::\n\n\nIf you were interested in taking this analysis a different direction, this would be a great branching point. Though in this pub we're going to focus exclusively on the sequence weights produced by the query biased outer product operation. To do that, we'll store the sequence weights relative to the query sequence for each layer, as well as the median sequence bias across layers, which was used in Figure FIXME. \n\n::: {#38773b2a .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:36.400073Z\",\"iopub.status.busy\":\"2025-10-06T19:53:36.399872Z\",\"iopub.status.idle\":\"2025-10-06T19:53:36.779992Z\",\"shell.execute_reply\":\"2025-10-06T19:53:36.779469Z\"}' execution_count=5}\n``` {.python .cell-code}\nimport pandas as pd\nfrom analysis.data import get_sequence_weight_data\nfrom analysis.tree import get_patristic_distance\n\ndata_dict = dict(\n    query=[],\n    subfamily=[],\n    target=[],\n    patristic_distance=[],\n    median_weight=[],\n)\n\nnum_layers = 22\nfor layer_idx in range(num_layers):\n    data_dict[f\"layer_{layer_idx}_weight\"] = []\n\nfor query in queries:\n    msa = msas[query]\n    targets = msa.ids_l\n\n    patristic_distances = get_patristic_distance(tree, query)\n    patristic_distances = patristic_distances[targets]\n\n    weights = get_sequence_weight_data(inference_results[query])\n    weights *= weights.size(1)\n    median_weights = torch.median(weights, dim=0).values\n\n    for layer_idx in range(num_layers):\n        data_dict[f\"layer_{layer_idx}_weight\"].extend(weights[layer_idx, :].tolist())\n\n    data_dict[\"query\"].extend([query] * len(targets))\n    data_dict[\"subfamily\"].extend(\n        [target_to_subfamily.get(target, \"Unknown\") for target in targets]\n    )\n    data_dict[\"target\"].extend(targets)\n    data_dict[\"median_weight\"].extend(median_weights.tolist())\n    data_dict[\"patristic_distance\"].extend(patristic_distances.tolist())\n\nresponse_regulator_df = pd.DataFrame(data_dict)\n```\n:::\n\n\n::: {#9ad7b1e0 .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:36.782011Z\",\"iopub.status.busy\":\"2025-10-06T19:53:36.781875Z\",\"iopub.status.idle\":\"2025-10-06T19:53:36.823852Z\",\"shell.execute_reply\":\"2025-10-06T19:53:36.823406Z\"}' execution_count=6}\n``` {.python .cell-code}\nresponse_regulator_df = response_regulator_df.query(\"query != target\").reset_index(drop=True)\nresponse_regulator_df\n```\n\n::: {.cell-output .cell-output-display execution_count=6}\n```{=html}\n<div>\n<style scoped>\n    .dataframe tbody tr th:only-of-type {\n        vertical-align: middle;\n    }\n\n    .dataframe tbody tr th {\n        vertical-align: top;\n    }\n\n    .dataframe thead th {\n        text-align: right;\n    }\n</style>\n<table border=\"1\" class=\"dataframe\">\n  <thead>\n    <tr style=\"text-align: right;\">\n      <th></th>\n      <th>query</th>\n      <th>subfamily</th>\n      <th>target</th>\n      <th>patristic_distance</th>\n      <th>median_weight</th>\n      <th>layer_0_weight</th>\n      <th>layer_1_weight</th>\n      <th>layer_2_weight</th>\n      <th>layer_3_weight</th>\n      <th>layer_4_weight</th>\n      <th>...</th>\n      <th>layer_12_weight</th>\n      <th>layer_13_weight</th>\n      <th>layer_14_weight</th>\n      <th>layer_15_weight</th>\n      <th>layer_16_weight</th>\n      <th>layer_17_weight</th>\n      <th>layer_18_weight</th>\n      <th>layer_19_weight</th>\n      <th>layer_20_weight</th>\n      <th>layer_21_weight</th>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <th>0</th>\n      <td>1NXS</td>\n      <td>GerE</td>\n      <td>A0A7X1E8S8_9BACT/9-121</td>\n      <td>2.786295</td>\n      <td>0.673984</td>\n      <td>1.307036</td>\n      <td>0.955561</td>\n      <td>1.263924</td>\n      <td>0.811360</td>\n      <td>0.817577</td>\n      <td>...</td>\n      <td>1.199011</td>\n      <td>0.974460</td>\n      <td>0.505713</td>\n      <td>0.329670</td>\n      <td>0.438824</td>\n      <td>0.430862</td>\n      <td>7.347680e-09</td>\n      <td>0.703340</td>\n      <td>1.508741e-13</td>\n      <td>0.729113</td>\n    </tr>\n    <tr>\n      <th>1</th>\n      <td>1NXS</td>\n      <td>LytTR</td>\n      <td>A0A3E3I7Q2_9FIRM/4-117</td>\n      <td>3.951529</td>\n      <td>0.825124</td>\n      <td>0.860811</td>\n      <td>0.886416</td>\n      <td>0.705370</td>\n      <td>0.729034</td>\n      <td>0.825159</td>\n      <td>...</td>\n      <td>0.655472</td>\n      <td>0.800791</td>\n      <td>0.885945</td>\n      <td>1.102348</td>\n      <td>0.813296</td>\n      <td>1.048996</td>\n      <td>1.482518e-04</td>\n      <td>0.824315</td>\n      <td>1.648761e-07</td>\n      <td>0.956229</td>\n    </tr>\n    <tr>\n      <th>2</th>\n      <td>1NXS</td>\n      <td>LytTR</td>\n      <td>A0A368URF1_9BACT/4-111</td>\n      <td>3.991798</td>\n      <td>0.902642</td>\n      <td>1.057170</td>\n      <td>0.969235</td>\n      <td>0.832926</td>\n      <td>0.902642</td>\n      <td>1.174863</td>\n      <td>...</td>\n      <td>0.623961</td>\n      <td>0.660154</td>\n      <td>0.874962</td>\n      <td>0.659585</td>\n      <td>0.653692</td>\n      <td>0.710641</td>\n      <td>2.025029e-08</td>\n      <td>0.702777</td>\n      <td>9.085868e-13</td>\n      <td>0.944115</td>\n    </tr>\n    <tr>\n      <th>3</th>\n      <td>1NXS</td>\n      <td>GerE</td>\n      <td>A0A916ZA47_9BACT/6-121</td>\n      <td>3.259311</td>\n      <td>0.905487</td>\n      <td>1.284459</td>\n      <td>0.998575</td>\n      <td>0.924237</td>\n      <td>1.130701</td>\n      <td>1.022248</td>\n      <td>...</td>\n      <td>0.824651</td>\n      <td>0.688256</td>\n      <td>1.151665</td>\n      <td>0.593614</td>\n      <td>0.766877</td>\n      <td>0.842766</td>\n      <td>2.107039e-08</td>\n      <td>1.082372</td>\n      <td>3.593515e-13</td>\n      <td>1.267654</td>\n    </tr>\n    <tr>\n      <th>4</th>\n      <td>1NXS</td>\n      <td>GerE</td>\n      <td>A0A1V0TS32_9ACTN/39-151</td>\n      <td>2.843446</td>\n      <td>0.605756</td>\n      <td>1.052481</td>\n      <td>0.809227</td>\n      <td>1.106168</td>\n      <td>0.733226</td>\n      <td>0.745208</td>\n      <td>...</td>\n      <td>1.306780</td>\n      <td>0.737931</td>\n      <td>0.382090</td>\n      <td>0.657085</td>\n      <td>0.518865</td>\n      <td>0.459059</td>\n      <td>2.394004e-08</td>\n      <td>0.495743</td>\n      <td>1.016207e-12</td>\n      <td>1.058251</td>\n    </tr>\n    <tr>\n      <th>...</th>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n      <td>...</td>\n    </tr>\n    <tr>\n      <th>12280</th>\n      <td>4E7P</td>\n      <td>LytTR</td>\n      <td>A0A0M3DH34_9CLOT/3-121</td>\n      <td>4.172793</td>\n      <td>0.899335</td>\n      <td>0.901332</td>\n      <td>0.899335</td>\n      <td>0.877918</td>\n      <td>1.008778</td>\n      <td>0.836281</td>\n      <td>...</td>\n      <td>1.205347</td>\n      <td>0.916148</td>\n      <td>0.815301</td>\n      <td>1.071517</td>\n      <td>1.099280</td>\n      <td>1.378445</td>\n      <td>3.207268e-03</td>\n      <td>1.251549</td>\n      <td>2.782375e-05</td>\n      <td>0.996691</td>\n    </tr>\n    <tr>\n      <th>12281</th>\n      <td>4E7P</td>\n      <td>GerE</td>\n      <td>A0A402BHW6_9CHLR/11-123</td>\n      <td>3.173051</td>\n      <td>1.001034</td>\n      <td>0.924093</td>\n      <td>0.807366</td>\n      <td>0.876067</td>\n      <td>1.023880</td>\n      <td>1.348463</td>\n      <td>...</td>\n      <td>0.911493</td>\n      <td>1.084337</td>\n      <td>0.856177</td>\n      <td>1.137771</td>\n      <td>1.241629</td>\n      <td>1.001034</td>\n      <td>5.438000e-07</td>\n      <td>0.761824</td>\n      <td>3.850473e-11</td>\n      <td>0.779721</td>\n    </tr>\n    <tr>\n      <th>12282</th>\n      <td>4E7P</td>\n      <td>GerE</td>\n      <td>A0A4Q9H4P7_9BURK/96-206</td>\n      <td>3.404453</td>\n      <td>0.735321</td>\n      <td>0.873935</td>\n      <td>1.221995</td>\n      <td>0.854079</td>\n      <td>1.015214</td>\n      <td>0.856288</td>\n      <td>...</td>\n      <td>0.508172</td>\n      <td>0.862002</td>\n      <td>0.675361</td>\n      <td>0.467971</td>\n      <td>0.512494</td>\n      <td>0.411883</td>\n      <td>9.529113e-10</td>\n      <td>0.785022</td>\n      <td>3.634170e-14</td>\n      <td>0.542588</td>\n    </tr>\n    <tr>\n      <th>12283</th>\n      <td>4E7P</td>\n      <td>OmpR</td>\n      <td>1NXS</td>\n      <td>3.267631</td>\n      <td>0.789194</td>\n      <td>1.061308</td>\n      <td>1.045597</td>\n      <td>0.899177</td>\n      <td>0.760406</td>\n      <td>0.744628</td>\n      <td>...</td>\n      <td>0.959732</td>\n      <td>1.224866</td>\n      <td>1.137369</td>\n      <td>0.789194</td>\n      <td>0.610255</td>\n      <td>0.655348</td>\n      <td>1.681009e-08</td>\n      <td>0.821820</td>\n      <td>4.737196e-13</td>\n      <td>1.023855</td>\n    </tr>\n    <tr>\n      <th>12284</th>\n      <td>4E7P</td>\n      <td>LytTR</td>\n      <td>4CBV</td>\n      <td>4.725586</td>\n      <td>1.127677</td>\n      <td>0.785026</td>\n      <td>0.817826</td>\n      <td>1.410500</td>\n      <td>1.127677</td>\n      <td>0.684006</td>\n      <td>...</td>\n      <td>3.211699</td>\n      <td>2.749835</td>\n      <td>1.399638</td>\n      <td>1.425674</td>\n      <td>1.639743</td>\n      <td>1.721472</td>\n      <td>1.404944e-02</td>\n      <td>1.714717</td>\n      <td>7.149433e-04</td>\n      <td>0.415134</td>\n    </tr>\n  </tbody>\n</table>\n<p>12285 rows × 27 columns</p>\n</div>\n```\n:::\n:::\n\n\n::: {#433a371b .cell execution='{\"iopub.execute_input\":\"2025-10-06T19:53:36.825919Z\",\"iopub.status.busy\":\"2025-10-06T19:53:36.825787Z\",\"iopub.status.idle\":\"2025-10-06T19:53:44.559030Z\",\"shell.execute_reply\":\"2025-10-06T19:53:44.558619Z\"}' execution_count=7}\n``` {.python .cell-code}\nimport arcadia_pycolor as apc\nimport matplotlib.pyplot as plt\n\napc.mpl.setup()\n\n\ndef plot_patristic_versus_median_weight(df: pd.DataFrame, weight_column=\"median_weight\") -> None:\n    categories = df[\"query\"].unique()\n    subfamilies = df[\"subfamily\"].unique()\n    fig, axes = plt.subplots(1, 3, figsize=(15, 5))\n    colors = apc.palettes.primary.colors[:3]\n\n    # Create color mapping for subfamilies\n    subfamily_colors = {subfamily: colors[i] for i, subfamily in enumerate(subfamilies)}\n\n    for i, category in enumerate(categories):\n        category_data = df[df[\"query\"] == category]\n\n        # Color points by subfamily instead of query\n        for subfamily in subfamilies:\n            subfamily_data = category_data[category_data[\"subfamily\"] == subfamily]\n            if not subfamily_data.empty:\n                axes[i].scatter(\n                    subfamily_data[\"patristic_distance\"],\n                    subfamily_data[weight_column],\n                    alpha=0.4,\n                    s=20,\n                    c=subfamily_colors[subfamily],\n                    label=subfamily,\n                )\n\n        axes[i].set_xlabel(\"Patristic Distance\")\n        axes[i].set_ylabel(\"Median Weight\")\n        axes[i].set_title(f\"{category}\")\n        axes[i].grid(True, alpha=0.3)\n\n        # Add legend only to first plot\n        axes[i].legend()\n\n    plt.tight_layout()\n    plt.show()\n\n\nplot_patristic_versus_median_weight(response_regulator_df)\n```\n\n::: {.cell-output .cell-output-display}\n![](index_files/figure-html/cell-8-output-1.png){width=1097 height=367}\n:::\n:::\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [],
    "includes": {
      "include-in-header": [
        "<script src=\"https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js\" integrity=\"sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==\" crossorigin=\"anonymous\"></script>\n<script src=\"https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js\" integrity=\"sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==\" crossorigin=\"anonymous\" data-relocate-top=\"true\"></script>\n<script type=\"application/javascript\">define('jquery', [],function() {return window.jQuery;})</script>\n"
      ]
    }
  }
}